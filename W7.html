<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>TON Transfer + Network Check</title>

  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
      text-align:center;
      padding:30px;
    }
    input {
      padding:8px;
      margin:5px;
      font-size:16px;
      width:250px;
    }
    button {
      padding:10px 20px;
      font-size:16px;
      margin-top:10px;
    }
  </style>
</head>

<body>

  <h2>ارسال TON با تشخیص شبکه</h2>

  <div id="ton-connect"></div>

  <p id="status">وضعیت: متصل نیست</p>

  <hr>

  <input id="address" placeholder="آدرس گیرنده"><br>
  <input id="amount" placeholder="مقدار TON"><br>
  <button onclick="sendTon()">ارسال TON</button>

  <script>

    let currentChain = null;   // -3 یا -239
    let isMainnet = false;     // وضعیت شبکه

    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://solider1385.github.io/Best-Coin.io/tonconnect-manifest.json",
      buttonRootId: "ton-connect"
    });

    tonConnectUI.onStatusChange((wallet) => {

      if(wallet){
        currentChain = wallet.account.chain;

        // تشخیص شبکه
        if(String(currentChain) === "-239"){
          isMainnet = true;
          alert("✔ شما روی MAINNET هستید");
        }
        else if(String(currentChain) === "-3"){
          isMainnet = false;
          alert("⚠ شما روی TESTNET هستید!");
        }
        else{
          isMainnet = false;
          alert("❓ شبکه ناشناخته! مقدار chain: " + currentChain);
        }

        document.getElementById("status").innerText =
          `متصل شد!\nآدرس: ${wallet.account.address}\nشبکه: ${currentChain}`;

      } else {
        currentChain = null;
        isMainnet = false;
        document.getElementById("status").innerText = "متصل نیست";
      }
    });

    async function sendTon(){

      if(!isMainnet){
        alert("❌ نمی‌توانی روی TESTNET تراکنش واقعی ارسال کنی!");
        return;
      }

      const to = document.getElementById("address").value.trim();
      const amount = document.getElementById("amount").value.trim();

      if(!to || !amount){
        alert("آدرس و مقدار را وارد کن.");
        return;
      }

      const nano = Math.floor(Number(amount) * 1e9);

      const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 300,
        messages: [{
          address: to,
          amount: nano.toString()
        }]
      };

      try{
        const result = await tonConnectUI.sendTransaction(tx);
        alert("✔ تراکنش ارسال شد!");
        console.log(result);
      }
      catch(err){
        alert("❌ خطا در ارسال تراکنش: " + err.message);
      }
    }

  </script>

</body>
</html>
