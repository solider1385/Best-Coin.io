<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>TON Transfer</title>

  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <style>
    body{
      font-family: sans-serif;
      padding: 30px;
      text-align:center;
    }
    input{
      padding:8px;
      font-size:16px;
      margin:5px;
      width: 260px;
    }
    button{
      padding:10px 20px;
      font-size:16px;
      margin-top:10px;
    }
  </style>
</head>

<body>

  <!-- Ø¯Ú©Ù…Ù‡ Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ -->
  <div id="ton-connect"></div>

  <h3>Ø§Ø±Ø³Ø§Ù„ TON</h3>

  <input id="address" placeholder="Ø¢Ø¯Ø±Ø³ Ú¯ÛŒØ±Ù†Ø¯Ù‡" /><br>
  <input id="amount" placeholder="Ù…Ù‚Ø¯Ø§Ø± TON" /><br>

  <button onclick="sendTon()">Ø§Ø±Ø³Ø§Ù„ TON</button>

  <p id="status">ÙˆØ¶Ø¹ÛŒØª: Ù…ØªØµÙ„ Ù†ÛŒØ³Øª</p>

  <script>

    /* -------------------------------
        Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ TonConnect UI
    --------------------------------*/
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://solider1385.github.io/Best-Coin.io/tonconnect-manifest.json",
      buttonRootId: "ton-connect"
    });

    let connectedWallet = null;

    /* -------------------------------
        ØªØ´Ø®ÛŒØµ Ø´Ø¨Ú©Ù‡ (Mainnet / Testnet)
    --------------------------------*/
    tonConnectUI.onStatusChange((wallet)=>{
      if(wallet){
        connectedWallet = wallet;
        const chain = wallet.account.chain;

        let chainName = "Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡";

        if(chain === "-239"){
          chainName = "âš  ØªØ³Øªâ€ŒÙ†Øª (Testnet)";
          alert("Ø´Ù…Ø§ Ø±ÙˆÛŒ Testnet Ù‡Ø³ØªÛŒØ¯! ØªØ±Ø§Ú©Ù†Ø´ ÙˆØ§Ù‚Ø¹ÛŒ Ù†Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯.");
        }
        else if(chain === "0"){
          chainName = "âœ” Ø´Ø¨Ú©Ù‡ Ø§ØµÙ„ÛŒ (Mainnet)";
        }

        document.getElementById("status").innerText =
          "Ù…ØªØµÙ„ Ø´Ø¯! Ø¢Ø¯Ø±Ø³: " + wallet.account.address + "\nØ´Ø¨Ú©Ù‡: " + chainName;

      } else {
        connectedWallet = null;
        document.getElementById("status").innerText = "Ù…ØªØµÙ„ Ù†ÛŒØ³Øª";
      }
    });


    /* -------------------------------------
        Ú†Ú© ÙˆØ¶Ø¹ÛŒØª ØªØ±Ø§Ú©Ù†Ø´ Ø¯Ø± Ø¨Ù„Ø§Ú©Ú†ÛŒÙ†
    -------------------------------------*/
    async function checkTransactionStatus(address){
      try{
        const url = `https://tonapi.io/v2/blockchain/transactions?account=${address}`;
        const res = await fetch(url);
        const data = await res.json();

        if (!data.transactions || data.transactions.length === 0)
          return false;

        return true; 
      } catch(err){
        console.error(err);
        return false;
      }
    }


    /* -------------------------------------
        Ø§Ø±Ø³Ø§Ù„ TON
    -------------------------------------*/
    async function sendTon(){

      if(!connectedWallet){
        alert("Ø§ÙˆÙ„ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ùˆ ÙˆØµÙ„ Ú©Ù† ğŸ™ƒ");
        return;
      }

      const toAddress = document.getElementById("address").value.trim();
      const amountTon = document.getElementById("amount").value.trim();

      if(!toAddress || !amountTon){
        alert("Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³ Ùˆ Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†");
        return;
      }

      const nanoTon = Math.floor(Number(amountTon) * 1e9);

      const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 300,
        messages: [
          {
            address: toAddress,
            amount: nanoTon.toString()
          }
        ]
      };

      try{
        const result = await tonConnectUI.sendTransaction(tx);

        alert("â³ ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯! Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯ Ù…ÛŒâ€ŒÙ…Ø§Ù†ÛŒÙ…...");

        setTimeout(async ()=>{
          const ok = await checkTransactionStatus(connectedWallet.account.address);

          if(ok){
            alert("ğŸ‰ ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø´Ø¨Ú©Ù‡ Ø«Ø¨Øª Ø´Ø¯!");
          }else{
            alert("âŒ ØªØ±Ø§Ú©Ù†Ø´ Ø¯Ø± Ø¨Ù„Ø§Ú©Ú†ÛŒÙ† Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!");
          }

        }, 2500);

      }catch(e){
        alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ØªØ±Ø§Ú©Ù†Ø´: " + e.message);
        console.error(e);
      }
    }

  </script>

</body>
</html>
