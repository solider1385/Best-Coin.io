<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>TON Connect Test</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: sans-serif;
      direction: rtl;
      padding: 10px;
    }
    button {
      padding: 8px 15px;
      margin: 5px;
    }
  </style>
</head>
<body>

<h2>اتصال کیف پول Tonkeeper</h2>

<button id="connectBtn">اتصال</button>
<br>
<p id="wallet">آدرس کیف پول: -</p>
<p id="balance">موجودی: -</p>


<script type="module">
import { TonConnect } from "https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js";

const manifestUrl = "https://solider1385.github.io/Best-Coin.io/tonconnect-manifest.json";

let connector;

try {
    connector = new TonConnect({ manifestUrl });
} catch(err) {
    alert("خطا در ساخت TonConnect: " + err);
}

document.getElementById("connectBtn").onclick = async () => {
    try {
        const wallets = await connector.getWallets();
        if (!wallets || wallets.length === 0) {
            alert("هیچ کیف پولی یافت نشد!");
            return;
        }

        const wallet = wallets[0];    // Tonkeeper

        await connector.connect({
            universalLink: wallet.universalLink,
            bridgeUrl: wallet.bridgeUrl
        });

        alert("✅ متصل شد!");

    } catch(err) {
        alert("❌ خطا در اتصال: " + err);
    }
};

/* بروزرسانی UI هنگام اتصال */
connector.onStatusChange(async (walletInfo) => {
    if (!walletInfo) return;

    const address = walletInfo.account.address;
    document.getElementById("wallet").textContent = "آدرس: " + address;

    try {
        // دریافت موجودی
        let res = await fetch(`https://toncenter.com/api/v2/getAddressBalance?address=${address}`);
        let data = await res.json();
        let nano = Number(data.result);
        let ton = nano / 1e9;

        document.getElementById("balance").textContent = "موجودی: " + ton + " TON";

    } catch(err) {
        document.getElementById("balance").textContent = "خطا!";
    }
});
</script>

</body>
</html>
