<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>TON Connect Test</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: sans-serif;
      direction: rtl;
      padding: 10px;
    }
    button {
      padding: 8px 15px;
      margin: 5px;
    }
  </style>
</head>
<body>

<h2>Ø§ØªØµØ§Ù„ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Tonkeeper</h2>

<button id="connectBtn">Ø§ØªÙ†ØµØ§Ù„</button>
<br>
<p id="wallet">Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„: -</p>
<p id="balance">Ù…ÙˆØ¬ÙˆØ¯ÛŒ: -</p>


<script type="module">
alert("âœ… JS Ø§Ø¬Ø±Ø§ Ø´Ø¯!");

import { TonConnect } from "https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js";

alert("âœ… TonConnect Ù„ÙˆØ¯ Ø´Ø¯!");

const manifestUrl = "https://solider1385.github.io/Best-Coin.io/tonconnect-manifest.json";

let connector;

try {
    connector = new TonConnect({ manifestUrl });
    alert("âœ… TonConnect Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!");
} catch(err) {
    alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª TonConnect: " + err);
}

document.getElementById("connectBtn").onclick = async () => {
    alert("â–¶ï¸ Ø¯Ú©Ù…Ù‡ Ø§ØªØµØ§Ù„ Ú©Ù„ÛŒÚ© Ø´Ø¯!");

    try {
        const wallets = await connector.getWallets();
        alert("ğŸ“¦ Wallets Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ = " + JSON.stringify(wallets));

        if (!wallets || wallets.length === 0) {
            alert("âŒ Ù‡ÛŒÚ† Ú©ÛŒÙ Ù¾ÙˆÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!");
            return;
        }

        const wallet = wallets[0];    // Tonkeeper
        alert("ğŸ”— ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡: " + wallet.name);

        await connector.connect({
            universalLink: wallet.universalLink,
            bridgeUrl: wallet.bridgeUrl
        });

        alert("âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ØªØµØ§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!");

    } catch(err) {
        alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: " + err);
    }
};


connector.onStatusChange(async (walletInfo) => {
    alert("ğŸ”„ onStatusChange");

    if (!walletInfo) {
        alert("âš ï¸ walletInfo Ø®Ø§Ù„ÛŒ Ø§Ø³Øª");
        return;
    }

    alert("âœ… WalletInfo = " + JSON.stringify(walletInfo));

    const address = walletInfo.account.address;
    document.getElementById("wallet").textContent = "Ø¢Ø¯Ø±Ø³: " + address;

    alert("ğŸ“¨ Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ...");

    try {
        let res = await fetch(`https://toncenter.com/api/v2/getAddressBalance?address=${address}`);
        alert("âœ… Ù¾Ø§Ø³Ø® toncenter");

        let data = await res.json();
        alert("âœ… JSON toncenter = " + JSON.stringify(data));

        let nano = Number(data.result);
        let ton = nano / 1e9;

        document.getElementById("balance").textContent = "Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " + ton + " TON";
        alert("âœ… Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " + ton);

    } catch(err) {
        alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ú¯Ø±ÙØªÙ† Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " + err);
        document.getElementById("balance").textContent = "Ø®Ø·Ø§!";
    }
});
</script>

</body>
</html>
